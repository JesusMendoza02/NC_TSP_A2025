{% extends 'base_feed.html' %}
{% load static %}

{% block contenido %}

<h1 class="page-title">Perfil</h1>

<div class="profile-header text-center mb-5 p-4">
    {% if turista.foto_perfil %}
        <img src="{{ turista.foto_perfil.url }}" alt="Foto de perfil" class="profile-pic mb-3">
    {% else %}
        <i class="bi bi-person-circle default-profile-icon mb-3"></i>
    {% endif %}
    
    <h2 class="username mb-0">{{ usuario.username }}</h2>
</div>

<hr class="my-4 profile-divider">

<h2 class="section-title text-center mb-4">Mis Publicaciones ({{ publicaciones|length }})</h2>

{% if publicaciones %}
    {% for publicacion in publicaciones %}
    <div class="card mb-4 shadow-sm p-4 profile-publication-card">
        <div class="row align-items-start g-3">
            
            <!-- Columna izquierda (información) -->
            <div class="col-md-7 profile-info-col">
                <h5 class="card-title publication-place mb-2">
                    <i class="bi bi-geo-alt-fill me-2 location-icon"></i> 
                    {{ publicacion.resena.lugar_turistico.nombre }}
                    <small class="text-muted d-block fw-normal location-subtitle">
                        {{ publicacion.resena.lugar_turistico.ubicacion }}
                    </small>
                </h5>

                <p class="card-text publication-description">{{ publicacion.resena.descripcion }}</p>

                <div class="mb-3 rating-section-profile">
                    <span class="fw-bold rating-label-profile">Calificación:</span>
                    <span class="ms-2 rating-value-profile">
                        {{ publicacion.resena.calificacion }} <i class="bi bi-star-fill text-warning"></i>
                    </span>
                </div>
                
                <small class="text-muted publication-meta d-block">
                    Publicado el: {{ publicacion.fecha_publicacion|date:"d M Y, H:i" }} | 👍 {{ publicacion.total_likes }} Likes
                </small>
            </div>

            <!-- Columna derecha (carrusel + menú) -->
            <div class="col-md-5 profile-carousel-col">
                
                <!-- Menú de opciones flotante (CORREGIDO) -->
                <div class="dropdown profile-action-menu">
                    <button class="btn btn-sm profile-menu-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end profile-dropdown">
                        <li>
                            <form method="post" action="{% url 'inicio:eliminar_publicacion' publicacion.id %}" 
                                  onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta reseña? Esta acción no se puede deshacer');" 
                                  class="m-0">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item delete-dropdown-item">
                                    <i class="bi bi-trash me-2"></i> Eliminar
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>

                {% if publicacion.resena.fotografias.all %}
                <div id="carousel-profile-{{ forloop.counter }}" class="carousel slide profile-carousel" data-bs-ride="carousel">
                    <div class="carousel-inner rounded-3 shadow-sm">
                        {% for foto in publicacion.resena.fotografias.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ foto.fotografia.url }}" class="d-block w-100 profile-carousel-img" alt="Foto reseña">
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Flechas del carrusel -->
                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel-profile-{{ forloop.counter }}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon profile-carousel-arrow" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carousel-profile-{{ forloop.counter }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon profile-carousel-arrow" aria-hidden="true"></span>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-info text-center profile-empty-alert">
        No has publicado nada aún. ¡Comparte tu primera reseña!
    </div>
{% endif %}

{% endblock contenido %}