{% extends "base_feed.html" %}
{% block titulo %}{{ publicacion.resena.lugar_turistico.nombre }}{% endblock %}
{% block contenido %}

<div class="container my-4">

    <!-- ðŸ”¹ CARD PUBLICACIÃ“N -->
    <div class="card shadow-sm" style="border-radius: 15px;">

        <!-- CABECERA USUARIO -->
        <div class="row g-3 p-3 align-items-center">
            <div class="col-md-auto d-flex align-items-center">
                {% if publicacion.turista.foto_perfil %}
                    <img src="{{ publicacion.turista.foto_perfil.url }}" class="rounded-circle me-3 shadow-sm" width="60" height="60">
                {% else %}
                    <i class="bi bi-person-circle me-3" style="font-size: 2rem; color: #6c757d;"></i>
                {% endif %}
                <div>
                    <h5 class="mb-0">
                        <a href="{% url 'perfil_usuario' publicacion.turista.usuario.username %}" class="text-decoration-none text-dark">
                            {{ publicacion.turista.usuario.username }}
                         </a>
                    </h5>
                    <small class="text-muted">{{ pub.fecha_publicacion|date:"d M Y, H:i" }}</small>
                </div>
            </div>
        </div>

        <!-- DETALLES DE LA PUBLICACIÃ“N -->
        <div class="row g-3 p-3">
            <div class="col-md-12">
                <h4 class="fw-bold">{{ publicacion.resena.lugar_turistico.nombre }}</h4>
                <p class="text-secondary mb-1"><i class="bi bi-tags"></i> {{ publicacion.resena.lugar_turistico.categoria }}</p>
                <p class="text-muted mb-2">{{ publicacion.resena.lugar_turistico.ubicacion }}</p>
                <p>{{ publicacion.resena.descripcion }}</p>
                <div class="mb-3">
                    <span class="fw-bold">CalificaciÃ³n:</span>
                    <span class="ms-2">{{ publicacion.resena.calificacion }} <i class="bi bi-star-fill text-warning"></i></span>
                </div>
            </div>
        </div>

        <!-- CARRUSEL FOTOS -->
        <div class="row g-3 p-3">
            <div class="col-md-12">
                {% with fotos=publicacion.resena.fotografias.all %}
                {% if fotos %}
                <div id="carouselDetalle" class="carousel slide mb-3 rounded" data-bs-ride="carousel">
                    <div class="carousel-inner rounded">
                        {% for foto in fotos %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ foto.fotografia.url }}" class="d-block w-100 img-clickable" style="max-height: 400px; object-fit: cover;" alt="Foto reseÃ±a" data-bs-toggle="lightbox">
                        </div>
                        {% endfor %}
                    </div>
                    {% if fotos|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselDetalle" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselDetalle" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                    {% endif %}
                </div>
                {% endif %}
                {% endwith %}
            </div>
        </div>

        <!-- LIKES -->
        <div class="row g-3 p-3">
            <div class="col-md-12 d-flex align-items-center mb-3">
                <button class="btn-like btn btn-outline-primary btn-sm me-2 {% if publicacion.id in likes_usuario %}liked{% endif %}" data-pub-id="{{ publicacion.id }}">
                    <i class="bi bi-hand-thumbs-up"></i> 
                </button>
                <small class="text-muted like-count">{{ publicacion.reaccion }} Likes</small>
            </div>
        </div>

        <!-- COMENTARIOS -->
        <div class="comentarios-section mt-3 p-3 border-top" style="background-color: #fafafa; border-radius: 0 0 15px 15px;">
            <h6 class="fw-bold mb-3 text-secondary"><i class="bi bi-chat-left-text"></i> Comentarios</h6>
            
            <div class="comentarios-list" style="max-height: 200px; overflow-y:auto;">
                {% if publicacion.comentarios.all %}
                    {% for comentario in publicacion.comentarios.all %}
                    <div class="comentario-item mb-2 pb-2 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong class="text-dark">{{ comentario.turista.usuario.username }}</strong>
                            <small class="text-muted">{{ comentario.fecha_creacion|date:"d M Y, H:i" }}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <p class="mb-0 text-muted" style="font-size: 0.9rem;">{{ comentario.texto }}</p>
                            {% if comentario.turista.usuario == user %}
                            <form method="POST" action="{% url 'feed:eliminar_comentario' comentario.id %}" style="margin:0;">
                                {% csrf_token %}
                                <button type="submit" class="btn-delete-comment">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">AÃºn no hay comentarios.</p>
                {% endif %}
            </div>

            <!-- FORMULARIO NUEVO COMENTARIO -->
            <form method="POST" action="{% url 'feed:escribir_comentario' publicacion.id %}" class="mt-3 w-100 d-flex comment-form" novalidate>
                {% csrf_token %}
                <div class="flex-grow-1 me-2">
                    <input type="text" name="texto" class="form-control" placeholder="Escribe un comentario..." maxlength="150">
                    <small id="error-comentario" class="text-danger d-none">Rellena este campo</small>
                </div>
                <button type="submit" class="btn-comment">
                    <i class="bi bi-send-fill me-1"></i> Comentar
                </button>
            </form>
        </div>
    </div>
</div>

<!-- LIGHTBOX -->
<div id="lightboxOverlay" class="lightbox-overlay">
    <img id="lightboxImage" src="" alt="Imagen completa">
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    // ===== LIKES =====
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    document.querySelectorAll('.btn-like').forEach(button => {
        button.addEventListener('click', async () => {
            const pubId = button.dataset.pubId;
            try {
                const response = await fetch("{% url 'feed:dar_like' 0 %}".replace('0', pubId), {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken,'Content-Type':'application/x-www-form-urlencoded'},
                    body: new URLSearchParams()
                });
                if (response.ok) {
                    const countElement = button.closest('.row').querySelector('.like-count');
                    let currentCount = parseInt(countElement.textContent) || 0;
                    if (button.classList.contains('liked')) {
                        button.classList.remove('liked');
                        countElement.textContent = (currentCount - 1) + ' Likes';
                    } else {
                        button.classList.add('liked');
                        countElement.textContent = (currentCount + 1) + ' Likes';
                    }
                }
            } catch (error) { console.error('Error en like:', error); }
        });
    });

    // ===== LIGHTBOX =====
    const overlay = document.getElementById('lightboxOverlay');
    const lightboxImage = document.getElementById('lightboxImage');
    document.querySelectorAll('#carouselDetalle .img-clickable').forEach(img => {
        img.addEventListener('click', () => {
            lightboxImage.src = img.src;
            overlay.style.display = 'flex';
        });
    });
    overlay.addEventListener('click', (e) => {
        if(e.target !== lightboxImage) {
            overlay.style.display = 'none';
            lightboxImage.src = '';
        }
    });

    // ===== VALIDACIÃ“N DE COMENTARIO =====
    const commentForm = document.querySelector('.comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', (e) => {
            const input = commentForm.querySelector('input[name="texto"]');
            const errorMsg = document.getElementById('error-comentario');
            if (!input.value.trim()) {
                e.preventDefault();
                errorMsg.classList.remove('d-none');
                input.classList.add('is-invalid');
            } else {
                errorMsg.classList.add('d-none');
                input.classList.remove('is-invalid');
            }
        });
    }

    // ===== ELIMINAR COMENTARIO =====
    document.querySelectorAll('.btn-delete-comment').forEach(btn => {
        btn.addEventListener('click', async e => {
            e.preventDefault();
            const form = btn.closest('form');
            const result = await Swal.fire({
                title: 'Â¿Eliminar comentario?',
                text: 'Esta acciÃ³n no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'SÃ­, eliminar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            });
            if (result.isConfirmed) {
                form.submit();
            }
        });
    });
});
</script>

<!-- ESTILOS -->
<style>
.is-invalid { border-color: #dc3545 !important; }
.comentarios-section { font-family: 'Inter', sans-serif; font-size: 0.92rem; }
.comentario-item strong { color: #333; }
.btn-delete-comment { background: transparent; border: none; color: #dc3545; font-size: 1rem; padding: 4px 6px; border-radius: 50%; transition: all 0.2s ease; }
.btn-delete-comment:hover { background-color: #f8d7da; color: #b02a37; }
.btn-comment { background-color: #0d6efd; color: white; border: none; border-radius: 8px; font-size: 0.9rem; padding: 6px 14px; display:flex; align-items:center; transition: 0.2s; }
.btn-comment:hover { background-color: #0b5ed7; transform: scale(1.03); }
.comment-form input { border-radius:8px; border:1px solid #ccc; }
.comment-form input:focus { border-color:#0d6efd; box-shadow:0 0 3px rgba(13,110,253,0.4); }
.img-clickable { cursor: pointer; transition: transform 0.2s; }
.img-clickable:hover { transform: scale(1.02); }

/* LIGHTBOX */
.lightbox-overlay {
    display: none;
    position: fixed;
    top:0;
    left:0;
    width:100vw;
    height:100vh;
    background: rgba(0,0,0,0.8);
    justify-content:center;
    align-items:center;
    z-index:1050;
    cursor:pointer;
}
.lightbox-overlay img {
    max-width:90%;
    max-height:90%;
    object-fit:contain;
    border-radius:8px;
    cursor:default;
    box-shadow:0 4px 20px rgba(0,0,0,0.5);
    transition: transform 0.2s ease;
}
.lightbox-overlay img:hover { transform: scale(1.02); }
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

{% endblock %}
